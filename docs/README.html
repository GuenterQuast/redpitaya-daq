<h1 id="redpitaya-daq">redpitaya-daq</h1>
<p>Data acuisition for the <a href="https://redpitaya.com/de/">RedPitaya FPGA board</a> for physics laboratory courses</p>
<h2 id="overview">Overview</h2>
<p>The RedPitaya is a small, credit-card sized single board computer with a dual-core ARM Cortex-A processor and a XILINX Zynq 7010 FPGA. The board contains two fast ADCs and two DACs with 14 bit resolution running at a sampling frequency of 125 MHz. Extension connectors provide general purpose IO pins with slow analog inputs and outputs and support for serial bus interfaces like I²C, SPI and UART. The system runs under Linux, which provides network access and supports a wide range of applications running on the board.</p>
<p>Many laboratory instruments like oscilloscopes, logic analyzers, Bode plotters or a multi-channel pulse-height analyzer can be realized on this board by simply changing the FPGA image and the Linux application.</p>
<figure>
<img src="images/RedPitayaBoard-1024x526.png" width="800" alt="" /><figcaption>Image of the RedPitaya board (source: <code>redpitaya.com</code>).</figcaption>
</figure>
<p>The MCPHA application for the RedPitaya by Pavel Demin provides a multi-channel pulse-height analyzer as well as an oscilloscope capable of transferring large data rates reaching the theoretical limit of the one-Gbit ethernet port. The package consists of an FPGA image and a server process running on the RedPitaya board. A client script controls the server and pulls the data to the client computer.</p>
<p>This package extends the original client by a possibility to record or export waveform data and provides helper scripts to read back and analyze the recorded data. An interface to the buffer manager <em>mimoCoRB</em> for buffering and parallel processing of large date volumes is also provided.</p>
<p>This package is in use for gamma-ray spectroscopy experiments in physics laboratory courses at the Faculty of Physics at Karlsruhe Institute of Technology.</p>
<h3 id="files">Files:</h3>
<ul>
<li><em>README.md</em> this documentation</li>
<li><em>redPdaq.py</em> client for data-acquisition using the mcpha server</li>
<li><em>examples/</em> recorded spectra</li>
<li><em>examples/peakFitter.py</em> code to find and fit peaks in spectum data</li>
<li><em>read_npy.py</em> a simple example to read waveforms saved in <em>.npy</em> format</li>
<li><em>redP_mimocorb.py</em> runs <em>redPdaq</em> as a client of the buffer manager <em>mimoCoRB</em></li>
<li><em>setup.yaml</em> coniguration script defining the <em>mimoCoRB</em> application</li>
<li><em>modules/</em> and <em>config/</em> contain code and configuration files for the <em>redP_mimoCoRB</em> application</li>
<li><em>rpControl.ui</em> main qt5 window for <em>redPdaq</em><br />
</li>
<li><em>mcpha_log.ui</em> qt5 tab for message display</li>
<li><em>mcpha_hst.ui</em> qt5 tab for histogram display</li>
<li><em>mcpha_daq.ui</em> qt5 tab for oscilloscope with daq mode</li>
<li><em>mcpha_gen.ui</em> qt5 tab for generator</li>
<li><em>RP-image/</em> directory with all files necessary to boot a RedPitaya and start the server application based on the “small, simple and secure” linux distribution <a href="https://github.com/pavel-demin/red-pitaya-notes/releases/tag/20240204">alpine-3.18-armv7-20240204</a></li>
<li>utility scripts in the sub-directory <em>helpers/</em></li>
</ul>
<h2 id="credit">Credit:</h2>
<p>The code prvided here is based on a fork of the sub-directory <em>projects/mcpha</em> in a project by Pavel Demin, <a href="https://pavel-demin.github.io/red-pitaya-notes">red-pitaya-notes</a>.<br />
<em>redPdaq.py</em> contains an extension of the original oscilloscope class enabling fast restart and data export.</p>
<h1 id="users-guide">Users’ Guide</h1>
<p>This section presents a brief introduction to the basic usage of the funcionality provided by the <em>rediptaya-daq</em> package.</p>
<h2 id="multi-channel-pulse-height-analyzer-and-data-recorder-for-the-redpitaya-fpga-board">Multi-Channel Pulse-Height Analyzer and Data recorder for the RedPitaya FPGA board</h2>
<p>A multi-channel pulse-height analyzer produces a histogram of the heights of pulses present in a signal supplied to the input. The MCPHA project uses the FPGA on the RedPitaya board to process the digitized input signal at very high rates. A server process on the ARM processor of the RedPitaya communicates with a client process via network. The client communicates with the server, starts and stops data recording and receives and displays the data. The client is also responsible for saving data to files.</p>
<p>The original version by Pavel Demin has been modified to better meet the usual standards for graphics displays in physics. A command line interface has also been added to allow easy control of important parameters at program start. An extended version of the original oscilloscope display permits fast transfer of data to the client for data acquisition applications.</p>
<h3 id="basic-functionality">Basic functionality</h3>
<p>The algorithm implemented in the FPGA uses a rather simple, but straight-forward algorithm to determine the pulse-heights. When the signal voltage of a supplied input signal starts rising, the corresponding ADC count is stored. A second ADC value is stored when the signal level starts falling again, and the difference of these two ADC values is histogrammed. The histogram is transferred to the client upon request.</p>
<p>The client application also contains a signal generator that runs independently and parallel to the pulse-height analyzer. It provides exponential signals on the <em>out1</em> connector with configurable width and rate. It is possible to generate pulses according to a Poisson process with a given average rate, allowing to study effects of overlapping pulses (pile-up). Connecting <em>out1</em> with a (short) cable to one or both of the inputs <em>in1</em> or <em>in2</em> provides input signals that can be be used to familiarize with the functionality and to benchmark the performance.</p>
<p>An oscilloscope with very basic functionality to set the trigger level and direction is also provided. The timing is controlled by the so-called decimation factor that can be adjusted using the control in the upper right corner of the graphical window. The RedPitaya samples data at a constant rate of 125 MHz, and the decimation factor determines how many samples are averaged over and stored in the internal ring buffer. This reduces the effective sampling rate accordingly. Only decimation factors corresponding to powers of two are allowed. An example of randomly occurring exponential signal pulses at an average rate of 10 kHz with a fall time of 10 µs is shown below; there is significant signal overlap in this case, making pulse-height detection more complex.</p>
<figure>
<img src="images/oscilloscope_10mus10kHz.png" width="800" alt="" /><figcaption>Oscilloscope display of signals with a fall time of 10µs at an average rate of 10 kHz</figcaption>
</figure>
<p>A spectrum of such pulses is shown below for input pulses at multiples of 62.5 mV between 62.5 mV and 500 mV. The overlap of signal pulses leads to wrong pulse-height assignments below the actual voltage and to entries above 500 mV when pulses become indistinguishable and therefore add up to a single detected pulse.</p>
<figure>
<img src="images/spectrum_10mus10kHz.png" width="800" alt="" /><figcaption>Spectrum signals with a fall time of 10 µs at an average rate of 10 kHz</figcaption>
</figure>
<p>Note that spectra and waveforms are plotted with a very large number of channels, well exceeding the resolution of a computer display. It is therefore possible to use the looking-glass button of the <em>matplotlib</em> window to mark regions to zoom in for a detailed inspection of the data.</p>
<h2 id="oscilloscope-and-data-recorder">Oscilloscope and data recorder</h2>
<p>The original oscilloscpe display is extended by a “<em>Start DAQ</em>” button to run the oscilloscope in data acquisition mode, i.e. continuously. Only a subset of the data is shown in the oscilloscope display, together with information on the trigger rate and the transferred data volume. A configurable user-defined function may also be called to analyse and store the recorded waveforms. It is possible to transfer data over a one-Gbit network from the RedPitaya with a rate of up to 50 MB/s or about 500 waveforms/s.</p>
<p>An examples of call-back functions callable from within redPdaq is provided with the package</p>
<ul>
<li>redP_consumer()<br />
calculates and displays statistics on trigger rate and data volume.</li>
</ul>
<h3 id="running-redpdaq-as-a-mimocorb-client">Running redPdaq as a mimoCoRB client</h3>
<p><em>redP_mimocorb.py</em> is a script containing code to be started from the command line and a function definde in the script, <em>redP_to_rb</em>, is called as a sub-process within the <em>mimiCoRB</em> buffer manager frame-work for more advanced data analysis tasks requiring multiple processes running in parallel. A <em>mimoCoRB</em> setup-file is also provided and can be started by typing <code>redP_mimoCoRB.py setup.yaml</code> on the command line. Modules and configuration files for a pulse-height analysis of recorded signals are contained as exampless in the sub-directories <em>modules/</em> and <em>config/</em>, respectively.</p>
<h1 id="installation-of-the-package">Installation of the Package</h1>
<p>The sub-directory <em>RP-image</em> contains the necessary files to be transferred to a SD card for the RedPitaya board. Proceed as follows:</p>
<ul>
<li>copy the contents of the directory <em>RP-image</em> to an empty SD card formatted as VFAT32;</li>
<li>connect the RedPitaya to the network via the LAN port;</li>
<li>insert the SD card in the RedPitaya and connect the power.</li>
</ul>
<p>The RepPitaya directly starts the <em>mcpha</em> server application, requests an IP address via DHCP and waits for the client program to connect via network.</p>
<p>On the client computer, download the client software:</p>
<ul>
<li>clone the <em>redpitaya-daq</em> repository via <code>git clone https://gitlab.kit.edu/guenter.quast/redpitaya-daq</code>;</li>
<li>change directory to the installation directory and start the application program <em>redPdaq.py</em></li>
</ul>
<p>This client program takes care of initializing the processes on the RedPitaya board through the server, initiates data transfers from the RedPitaya board to the client computer and provides several tabs to visualize data, generate test pulses and to store the acquired spectra or waveforms.</p>
<h3 id="network-connection-to-the-redpitaya-board">Network connection to the RedPitaya Board</h3>
<p>Connecting to the RedPitaya with a LAN cable is the recommended way of access. The RedPitaya requests an ip-address via the dhcp protocol and becomes accessible under the name <em>rp-xxxxxx</em>, where <em>xxxxxx</em> are the last six characters of the ethernet MAC address.</p>
<p>If a usb-to-ethernet adapter is used and a dhcp server on the client computer is enabled for the interface, a one-to-one connection of the RedPitaya to a host computer can easily be established; use the name <em>rp-xxxxxx.local</em> in this case. How to set up a <em>dhcp</em> server for a usb-to-ethernet adapter depends on the operating system used on the client computer; please check the relevant documentation for your system.</p>
<h2 id="usage">Usage</h2>
<p>First, boot the RedPitaya with the proper SD card inserted. This starts the FPGA code and the server process on the RedPitaya board.</p>
<p>Then, on the client side:</p>
<ul>
<li><p>start the client program from within a terminal via <code>python3 redPdaq.py</code>;</p></li>
<li><p>in the graphical interface, enter the network address of the RedPitaya in the field next to the orange button and click <em>connect</em>; watch out for connection errors in the <em>Messages</em> tab! The message “<em>IO started</em>” is displayed if everything is ok, and the address turns green;</p></li>
<li><p>click the <em>oscilloscope</em> tab, check the trigger level and then start the oscilloscope to see whether signals are arriving at one or both of the RedPitaya inputs; adjust the <em>decimation factor</em> in the top-right corner of the main display to ensure that the sampling rate is high enough for about 50 samples over the pulse duration.</p></li>
<li><p>if no signal source is available, you may click the <em>generator</em> tab, set the desired signal parameters and start the generator; connect <em>out1</em> of the RedPitaya to one of<br />
rhe inputs with a (short) cable and then check for the presence of signals in the <em>oscilloscpe</em> tab;</p></li>
<li><p>now click the tab <em>spectrum histogram 1</em>; adjust the amplitude threshold and time of exposure, then click the <em>Start</em> button and watch the spectrum building up;</p></li>
<li><p>if running <code>redPdaq.py</code>, threre is a buttton “StartDQQ”; click it to cintinuously transfer waveform data to the client computer. If a filename was specified, data is recorded to disk in <em>.npy</em> format; note that any active spectrum rab is put in paused mode if DAQ is active.</p></li>
<li><p>when finished, use the <em>Save</em> button to save the spectrum to a file with a meaningful name.</p></li>
</ul>
<h2 id="helper-scripts">Helper scripts</h2>
<p>The directory <em>helpers/</em> contains helper scripts to read and visualize data from files written by <em>mcpha.py</em>, for both spectrum histograms and exported waveforms. Note that presently mcpha.py exports data in human-readable format using <em>numpy.savetxt()</em>.</p>
<blockquote>
<p><em>generate_spectrum_input.py</em> is a script to to generate input spectra for the signal generator of mcpha.py The convention is to use 4096 channels for a range from 0 to 500 mV. Pulse heights are drawn randomly from this spectrum, and pulses are formed according to the frequency and the rise and fall times specified in the graphical interface. The signals are available at the <em>out1</em> connector of the RedPitaya board.</p>
<p>Pulses can be generated at a fixed frequency, or with random timing corresponding to a Poisson process with a mean pulse rate given by the chosen frequency. The latter option is useful to study “pile-up” effects from overlapping pulses.</p>
</blockquote>
<blockquote>
<p><em>read_hst.py</em> illustrates how to read and plot spectrum data exported by mcpha.py.</p>
</blockquote>
<blockquote>
<p><em>read_osc.py</em> demonstrates how to read and plot waveform data exported from the oscilloscope tab of mcpha.py.</p>
</blockquote>
<blockquote>
<p><em>read_npy.py</em> illustrates how to read waveform recorded by <code>redPdaq.py</code>.</p>
</blockquote>
<h2 id="examples">Examples</h2>
<p>The directory <em>examples/</em> contains some spectra recorded with <em>redPdaq.py</em> and the Python program <em>peakFitter.py</em> to find and precisely fit peaks in recorded spectra. An example is shown here:</p>
<figure>
<img src="images/Spectrum.png" width="800" alt="" /><figcaption>Spectrum with fitted peaks</figcaption>
</figure>
<h2 id="license">License</h2>
<p>Like the original code by Pavel Demin, this open-source code is provided under the MIT License.</p>
<h2 id="project-status">Project status</h2>
<p>This project has been developed for experiments in the physics lab courses at the Faculty of Physics at Karlsruhe Institute of Technology. The code is already public, but presently still under test.</p>
